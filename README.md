Mutation Analysis Plugin for Sonarqube
======================================

This plugin enables Mutation Analyis of reports generated by [Pitest](http://pitest.org/) in Sonar Qube

[![Build Status](https://travis-ci.org/devcon5io/mutation-analysis-plugin.svg?branch=master)](https://travis-ci.org/devcon5io/mutation-analysis-plugin)  
[![Quality Gate Status](https://sonarcloud.io/api/project_badges/quality_gate?project=ch.devcon5.sonar%3Amutation-analysis-plugin)](https://sonarcloud.io/dashboard?id=ch.devcon5.sonar%3Amutation-analysis-plugin) 


Compatibility
-------------

This plugin requires at minimum the 6.7.x LTS version of SonarQube. 
This plugin is supported on the latest SonarQube version: 7.1.    

The minimum requirement is an arbitrary choice to encourage the use of the latest LTS release. Our goal is further to also support the latest version.

If you're running on a version prior to 6.7.3, you could

- use the [sonar-pitest-plugin](https://github.com/VinodAnandan/sonar-pitest) which provides less features but runs on earlier version of SonarQube
- create a custom built/backport:
    - checkout the code
    - lower the sonar-api version
    - run `mvn clean install` and pray no modifications are required (which might actually be the case down to a specific version)
- send a mail to [DevCon5](mailto:info@devcon5.ch) to create a backport to a lower version (additional development will be charged by case)

Manual Installation
-------------------

Copy the plugin jar into `extensions/plugin` directory and restart the server.

Setup
-----

### General Settings

_These steps are optional_

Under _Administration_ > _Configuration_ > _Mutation Analyis_ you may configure:

- _Active Pitest Sensor_ - turn the sensor on or off (default: `on`)
- _Effort Factor: Missing Coverage_ - configure the factor for calculating tbe total effort to add more coverage (default is `1.0`)
- _Effort Factor:  Survived Mutant_ - configure the factor for calculating tbe total effort to kill a survived mutant (default is `1.0`)
- _Effort: Kill a mutant_ - configure the base effort to kill a mutant (default is `15min`)
- _Enable Experimental Features_ - Some of the newer features are in experimental state and are disabled by default. These feature are not yet fully
tested both in automated tests and practice. Activating these feature _might_ break the analysis but may also provide additional insights into your code.
- _Output directory for the PIT reports_ the subdirectory of a maven project where the pitest report is located (default: `target/pit-reports`)

The effort settings are used to calculate the effort to decrease the technical debt. The default values are arbitrary and are not based on
any empirical research.

### Quality Profile

_In order to run a Mutation Analysis a profile with mutation analysis specific rules enable must be used._

The plugin contains a built-in quality profile, that contains all mutator-specific rules. 

If you're using custom profile, you may activate the Mutation Capabilities by adding the mutator rules to the profile:

0. Optional: Create a new custom profile or create a copy of an existing profile  
1. Edit your profile
2. In the rules box, click on "Activate More"
3. In the search:
   1. Select Repository _Mutation Analysis_
   2. Select Tag _mutation-operator_ (maybe you have to search for it)
   3. Click on _Bulk change_
   4. Activate in your profile
   
Running a mutation analysis
---------------------------

The plugin itself does _not_ conduct the actual analysis but processes the reports produced by [Pitest](http://pitest.org/).
Following the [Quickstart](http://pitest.org/quickstart/maven/) to create a Pitest report, add the following plugin to your POM.

It's important to enable the XML report in the output formats section.

```xml
<plugin>
    <groupId>org.pitest</groupId>
    <artifactId>pitest-maven</artifactId>
    <version>LATEST</version>
    <configuration>
        <targetClasses>
            <param>com.your.package.root.want.to.mutate*</param>
        </targetClasses>
        <targetTests>
            <param>com.your.package.root*</param>
        </targetTests>
        <outputFormats>
            <param>XML</param><!-- this generates the reports parsed by the plugin -->
            <param>HTML</param>
        </outputFormats>
    </configuration>
</plugin>
```

And run Maven
```bash
mvn org.pitest:pitest-maven:mutationCoverage
```

Afterwards run the Sonar Analysis (assuming you have configured your Sonarqube server already)
```bash
mvn sonar:sonar
```

Rules
-----

The plugins contains a set of rules.

- _Generic Rules_ (not active by default)
    - `Survived Mutants` - Any mutant that is not detected but covered by a test 
    - `Lurking Mutants` - Any mutant that is not covered by a test
    - `Mutant with unknown Status` - Any mutant for which the status could not be determined for any reason
    - `Mutation Coverage below threshold` - If the Mutation Coverage of a class is below a specific threshold (default: 80%)
- _Mutation Operator specific rules_ (active by default) 
    - `Argument Propagation Mutator`
    - `Boolean False Return Vals Mutator`
    - `Boolean True Return Vals Mutator`
    - `Conditionals Boundary Mutator`
    - `Constructor Call Mutator`
    - `Empty Object Return Vals Mutator`
    - `Increments Mutator`
    - `Inline Constant Mutator`
    - `Invert Negs Mutator`
    - `Math Mutator`
    - `Negate Conditionals Mutator`
    - `Non Void Method Call Mutator`
    - `Null Return Vals Mutator`
    - `Primitive Returns Mutator`
    - `Return Vals Mutator`
    - `Void Method Call Mutator`
    - `Member Variable Mutator (Beta)`
    - `Naked Receiver Mutator (Beta)`
    - `Remove Increments Mutator (Beta)`
    - `Remove Switch Mutator (Beta)`
    - `Return Values Mutator (Beta)`
    - `Switch Mutator (Beta)`

The _Mutation Operator specific rules_ provide detailed information what specific mutation has not been killed and provided a description similar
to the Mutator description of Pitest, which helps understanding the results without having to switch between different documentation sources. 

If you're using these specific rules, there is no need for the Generic Rules (apart from the 
`Mutation Coverage below threshold` rule) as this would bloat the analysis result with redundant issues. 
It's recommended to use the mutator specific rules.

The rules marked _Beta_ relate to _Experimental_ rules of Pitest. It's safe to activate these rules by default as they only become effective, when
you explicitly enable these mutation operators in your Pitest configuration.

Metrics
-------

The plugin calculates a set of metrics that help determine the effectiveness of your test suite and facilitate finding the areas to concentrate
unit test development effort on.

All these measures can be found in the _Measures_ view of your project in the _Mutation Analysis_ domain. 

Metrics marked with (beta) are experimental features that have to be enabled in the plugin settings.
These features might be subject to change in future releases or do not yet work as expected in all cases. For example
the %-valued metrics currently do not work for multi-module projects.

- _Alive: Survivors_ - Number of mutations not killed by a test (see Survivor rule)

- _Alive: Not Covered_ - Number of mutations non covered by any test (see Lurker rule)

- _Alive: Total % (beta)_ - The ratio of non-covered & surviving mutations to the total number of mutations. This gives an indication where your test 
development efforts should concentrate on. The major difference to the Mutation Coverage metric is, that this is global while the
coverage is local. For single-module projects, there shouldn't be a difference, but for multi-module projects there is. For example
when a single class has very low coverage, but only 2 mutations, it would still rank very high on the coverage metrics, while on
the Alive Total it would rank much lower compared to a class that has higher coverage but more absolute surviving mutants. Also note,
the measure always sums up to 100% on project level.

- _Killed: Total_ - The number of all mutations that are either _killed by a test_,_killed by a timeout_ or _killed by a memory error_

- _Killed: by Tests_ - Number of mutations killed by tests

- _Killed: by Memory Error_ - Number of mutations detected by memory errors (the test execution failed with a memory related exception)

- _Killed: by Timeout_ - Number of mutations detected by time outs (the test took unusually long)

- _Mutation: Coverage_ - Ratio (%) of how many mutations got killed vs. total mutations (i.e. 67% got killed). In multi-module projects, the values
get averaged based on the children, where each children contributes equally. Therefore the computed value might be higher and the Test Kill % might
provide a better indication of the overall kill ratio accross the entire project.

- _Mutation Density (beta)_ - Number of Mutations per coverable lines (lines to cover). This measure should give an indication of the density of your code.
    A value > 100% indicates more than 1 mutation per line (statistically). High values (such as 400%) indicate very dense code. This
    value also depends on the active mutation operators. When you have dedicated classes for constants, the "inline constants" mutator generates
    mutations in this class, although there might be little or no coverage line in the same class.
    On the other hand, a density of < 100% might be an indication of too verbose code, where you need to many lines to express
    your logic, which could negatively affect the maintainability.  

- _Mutations: Total_ - Total number of mutations generated

- _Mutations: Total % (beta)_ - Same as _Total Mutations_ but in % to see the distribution of the mutations across your project. This enables a TreeMap view in 
SonarQube which allows a better visual representation of the hotspots in your codebase.

- _Test: Kills_ - Number of Mutations killed by a specific tests, with a per-test drill-down. This might indicate a weakness in your test suite where
most of the tests is done by one or a few tests.
Note that Pitest aborts a mutation run for a single mutant if one test killed it to improve execution time. This _first_ test is displayed in this measure. 

- _Test: Kills % (beta)_ - Same as _Test Kills_ but in % of the total number of kills to better visualize test-kill distribution across your project. This 
enables a TreeMap view in SonarQube. This not the same as the Mutation Coverage. Test Kills % describes the number of all mutations have been killed while
the score is how many mutations have been killed _per component_. Therefore the drill-down shows different values and the total is averaged aggregation.

- _Unknown Status_ - Number of mutations with unknown status (see Unknown status rule). This metric is usually not visible.

Contributing
============

Any contributions are welcome (code, tests, documentation, bugfixes, features, feature-requests, ... ).

It would be nice if you follow the [SonarQube Developer Guidelines](https://github.com/SonarSource/sonar-developer-toolset#code-style) or stick close to them.
All tests must be passing.
